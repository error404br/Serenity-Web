<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Serenity Web â€” Simulateur de Cashflow (MVP)</title>
  <meta name="description" content="Projetez votre cash Ã  90 jours ou 12 mois. Indicateurs: taux dâ€™endettement, reste Ã  vivre, taux dâ€™Ã©pargne.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--brand:#0b2545}
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:1.25rem;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .kpi-label{font-size:.75rem;color:#64748b}
    .kpi-value{font-size:1.35rem;font-weight:800}
    .chip{border:1px solid #e5e7eb;border-radius:9999px;padding:.4rem .8rem;font-size:.85rem;cursor:pointer}
    .chip.active{background:#0b2545;color:#fff;border-color:#0b2545}
    .btn-del{border:1px solid #e5e7eb;border-radius:.65rem;padding:.35rem .6rem;font-size:.8rem}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-5 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-xl bg-[color:var(--brand)]"></div>
        <span class="font-semibold">Serenity Web <span class="text-slate-500">VERSION PDF BETA ACTIVE</span></span>
      </div>
      <nav class="text-sm hidden sm:flex gap-6">
        <a href="#simulateur" class="hover:underline">Simulateur</a>
        <a href="#projection" class="hover:underline">Projection</a>
        <a href="#faq" class="hover:underline">FAQ</a>
      </nav>
      <a href="#simulateur" class="px-3 py-2 rounded-xl bg-[color:var(--brand)] text-white text-sm">Essayer maintenant</a>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-6xl mx-auto px-5 py-12 md:py-16">
    <div class="grid md:grid-cols-2 gap-10 items-center">
      <div>
        <h1 class="text-3xl md:text-5xl font-extrabold leading-tight">
          Votre finance, claire et sereine.
        </h1>
        <p class="mt-4 text-slate-600">
          Projetez <strong>90 jours</strong> ou <strong>12 mois</strong> en 1 minute. Taux dâ€™endettement, reste Ã  vivre, taux dâ€™Ã©pargne â€” <em>calcul 100% local, sans inscription</em>.
        </p>
        <div class="mt-6 flex flex-wrap gap-3">
          <a href="#simulateur" class="px-4 py-3 rounded-2xl bg-[color:var(--brand)] text-white font-semibold">Lancer le simulateur</a>
          <a href="#projection" class="px-4 py-3 rounded-2xl bg-white border border-slate-200">Voir un exemple</a>
        </div>
        <p class="mt-3 text-xs text-slate-500">Pas de collecte bancaire â€¢ Gratuit â€¢ Export mail</p>
      </div>
      <div class="card p-6">
        <div class="aspect-video rounded-2xl bg-gradient-to-br from-slate-100 to-white grid place-items-center text-slate-500">
          Graphiques solde & revenus/dÃ©penses
        </div>
        <p class="mt-4 text-sm text-slate-600">
          La version Pro permet dâ€™enregistrer plusieurs scÃ©narios, dâ€™obtenir des alertes e-mail et dâ€™exporter vos projections en PDF.
        </p>
      </div>
    </div>
  </section>

  <!-- Simulateur -->
  <section id="simulateur" class="max-w-6xl mx-auto px-5 py-8 grid lg:grid-cols-2 gap-8">
    <!-- ParamÃ¨tres -->
    <div class="card p-6">
      <h2 class="text-xl font-bold">Vos paramÃ¨tres</h2>
      <p class="text-sm text-slate-600">Renseignez un solde initial et vos flux rÃ©currents.</p>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-slate-600 mb-1">Solde initial</label>
          <input id="base" type="number" class="w-full border rounded-xl p-2" value="0" step="0.01">
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Devise</label>
          <select id="currency" class="w-full border rounded-xl p-2">
            <option value="$" selected>$</option>
            <option value="â‚¬">â‚¬</option>
            <option value="C$">C$</option>
          </select>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3 items-center">
        <div>
          <label class="block text-sm text-slate-600 mb-1">Horizon</label>
          <div class="flex items-center gap-2">
            <input type="radio" name="hmode" id="mode90" value="90" checked>
            <label for="mode90" class="text-sm">90 jours</label>
            <input type="radio" name="hmode" id="mode365" value="365" class="ml-4">
            <label for="mode365" class="text-sm">12 mois</label>
          </div>
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Horizon (jours)</label>
          <input id="horizon" type="number" class="w-full border rounded-xl p-2" value="90" min="30" max="365">
          <p class="text-[11px] text-slate-500 mt-1">Basculer 90j/12m ajuste automatiquement.</p>
        </div>
      </div>

      <div class="mt-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Lignes de revenus/dÃ©penses</h3>
          <button id="addRow" class="text-sm px-3 py-1 rounded-lg bg-slate-900 text-white">+ Ajouter</button>
        </div>
        <div class="grid grid-cols-12 gap-2 text-[12px] text-slate-500">
          <div class="col-span-2">Type</div>
          <div class="col-span-2">Montant</div>
          <div class="col-span-3">RÃ©currence</div>
          <div class="col-span-3">CatÃ©gorie</div>
          <div class="col-span-2">DÃ©but</div>
        </div>
        <div id="rows" class="space-y-3 mt-1"></div>
        <p class="mt-2 text-xs text-slate-500">CatÃ©gories: <strong>Fixe</strong> (loyer, assurances), <strong>Variable</strong> (courses, loisirs), <strong>CrÃ©dit</strong> (mensualitÃ©).</p>
      </div>

      <div class="mt-6 flex flex-wrap gap-2">
        <button id="compute" class="px-4 py-3 rounded-2xl bg-emerald-600 text-white font-semibold">Calculer ma projection</button>
        <button id="resetScn" class="px-4 py-3 rounded-2xl bg-white border">RÃ©initialiser</button>
      </div>

      <!-- ScÃ©narios -->
      <div class="mt-4 flex flex-wrap gap-2">
        <span class="text-sm text-slate-600 mr-2">ScÃ©narios rapides :</span>
        <button class="chip" data-scn="var-10">âˆ’10% variables</button>
        <button class="chip" data-scn="rev+200">+200 / mois revenus</button>
        <button class="chip" data-scn="cred+300">+300 / mois crÃ©dit</button>
      </div>
    </div>

    <!-- Indicateurs -->
    <div class="card p-6">
      <h2 class="text-xl font-bold">Indicateurs</h2>
      <div class="grid sm:grid-cols-3 gap-3 mt-3">
        <div class="p-4 rounded-2xl bg-slate-50">
          <div class="kpi-label">Taux dâ€™endettement</div>
          <div id="kpiDebt" class="kpi-value">â€”</div>
          <div class="text-xs text-slate-500 mt-1">IdÃ©al &lt; 35%</div>
        </div>
        <div class="p-4 rounded-2xl bg-slate-50">
          <div class="kpi-label">Reste Ã  vivre (mensuel)</div>
          <div id="kpiRav" class="kpi-value">â€”</div>
          <div class="text-xs text-slate-500 mt-1">AprÃ¨s charges fixes & variables</div>
        </div>
        <div class="p-4 rounded-2xl bg-slate-50">
          <div class="kpi-label">Taux dâ€™Ã©pargne</div>
          <div id="kpiSave" class="kpi-value">â€”</div>
          <div class="text-xs text-slate-500 mt-1">Objectif 10â€“20%/mois</div>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-3 text-center mt-6">
        <div class="p-4 rounded-2xl bg-emerald-50">
          <div class="text-xs text-slate-600">M+1</div>
          <div id="m1" class="text-2xl font-extrabold">â€”</div>
        </div>
        <div class="p-4 rounded-2xl bg-amber-50">
          <div class="text-xs text-slate-600">M+6</div>
          <div id="m6" class="text-2xl font-extrabold">â€”</div>
        </div>
        <div class="p-4 rounded-2xl bg-rose-50">
          <div class="text-xs text-slate-600">M+12</div>
          <div id="m12" class="text-2xl font-extrabold">â€”</div>
        </div>
      </div>

      <p id="alert" class="mt-4 text-sm"></p>

      <!-- Liens mail & Excel -->
      <div class="mt-6 grid gap-3 sm:grid-cols-2">
        <a id="mailtoCta" href="#" class="text-center px-4 py-3 rounded-2xl bg-[color:var(--brand)] text-white font-semibold">
          Recevoir ma projection par e-mail
        </a>
        <a href="https://www.etsy.com/ca-fr/listing/1766882287/previsionnel-comptable-bilan" class="text-center px-4 py-3 rounded-2xl bg-white border border-slate-200">
          ðŸ“¥ TÃ©lÃ©charger Serenity Files (Excel)
        </a>
      </div>

      <!-- Bouton Export PDF -->
      <div class="mt-3">
        <button id="exportPdf" class="px-4 py-3 rounded-2xl bg-slate-900 text-white font-semibold w-full sm:w-auto" disabled>
          ðŸ”’ Exporter en PDF (beta)
        </button>
        <p class="text-xs text-slate-500 mt-1">
          Pour lâ€™instant ouvert Ã  tous pour test local. En bÃªta publique, ce bouton sera rÃ©servÃ© aux comptes Pro.
        </p>
      </div>

    </div>
  </section>

  <!-- Projection -->
  <section id="projection" class="max-w-6xl mx-auto px-5 py-8 grid lg:grid-cols-2 gap-8">
    <div class="card p-6">
      <h3 class="text-lg font-semibold">Solde projetÃ©</h3>
      <canvas id="chartLine" class="mt-4"></canvas>
    </div>
    <div class="card p-6">
      <h3 class="text-lg font-semibold">Revenus vs DÃ©penses (par mois)</h3>
      <canvas id="chartBars" class="mt-4"></canvas>
    </div>
  </section>

  <!-- FAQ -->
  <section id="faq" class="max-w-6xl mx-auto px-5 py-8">
    <h3 class="text-xl font-bold">FAQ rapide</h3>
    <div class="mt-4 grid md:grid-cols-2 gap-4">
      <div class="card p-4">
        <p class="font-semibold">Mes donnÃ©es sont-elles stockÃ©es ?</p>
        <p class="text-sm text-slate-600 mt-1">Par dÃ©faut, non : tout est calculÃ© dans votre navigateur. Vous pouvez activer la sauvegarde locale (automatique) pour reprendre lÃ  oÃ¹ vous vous Ãªtes arrÃªtÃ©.</p>
      </div>
      <div class="card p-4">
        <p class="font-semibold">Puis-je enregistrer un scÃ©nario ?</p>
        <p class="text-sm text-slate-600 mt-1">Dans ce MVP, vos entrÃ©es se rechargent automatiquement depuis votre navigateur. La version Pro ajoutera sauvegarde cloud, alertes et export PDF.</p>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="mt-10 border-t">
    <div class="max-w-6xl mx-auto px-5 py-8 text-sm text-slate-600 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
      <div>Â© Serenity Web â€” un projet BuildToSolve</div>
      <a href="mailto:sinlocka@gmail.com" class="underline">sinlocka@gmail.com</a>
    </div>
  </footer>

  <!-- Logiciel client -->
  <script>
    // ================ Utils ================
    const el = s => document.querySelector(s);
    const els = s => Array.from(document.querySelectorAll(s));
    const today0 = () => { const d=new Date(); d.setHours(0,0,0,0); return d; };
    const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
    const endOfMonth = (d) => new Date(d.getFullYear(), d.getMonth()+1, 0);
    const monthKey = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
    const debounce = (fn, t=250) => { let id; return (...args)=>{ clearTimeout(id); id=setTimeout(()=>fn(...args), t); }; };
    const fmtMoney = (n, cur) => {
      if (!isFinite(n)) return 'â€”';
      const sign = n < 0 ? '-' : '';
      return `${sign}${cur}${Math.abs(Number(n)).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
    };

    // ================ State (localStorage) ================
    const LS_KEY = 'serenityweb_state_v1';
    function saveState(state){
      try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch(e){}
    }
    function loadState(){
      try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
    }

    // ================ Dynamic Rows ================
    const rows = el('#rows');
    function lineRow(defaults = {}){
      const wrap = document.createElement('div');
      wrap.className = "grid grid-cols-12 gap-2 items-end";
      wrap.innerHTML = `
        <select class="col-span-2 border rounded-xl p-2 type">
          <option value="income">Revenu</option>
          <option value="expense">DÃ©pense</option>
        </select>
        <input class="col-span-2 border rounded-xl p-2 amount" type="number" placeholder="Montant" step="0.01">
        <select class="col-span-3 border rounded-xl p-2 rec">
          <option value="oneoff">Ponctuel</option>
          <option value="weekly">Hebdo</option>
          <option value="monthly" selected>Mensuel</option>
          <option value="quarterly">Trimestriel</option>
          <option value="yearly">Annuel</option>
        </select>
        <select class="col-span-3 border rounded-xl p-2 cat">
          <option value="fixed">Fixe</option>
          <option value="variable">Variable</option>
          <option value="credit">CrÃ©dit</option>
        </select>
        <div class="col-span-2 flex gap-2">
          <input class="border rounded-xl p-2 start flex-1" type="date">
          <button class="btn-del" title="Supprimer">ðŸ—‘</button>
        </div>
      `;
      // defaults
      if (defaults.type) wrap.querySelector('.type').value = defaults.type;
      if (defaults.amount!=null) wrap.querySelector('.amount').value = defaults.amount;
      if (defaults.rec) wrap.querySelector('.rec').value = defaults.rec;
      if (defaults.cat) wrap.querySelector('.cat').value = defaults.cat;
      if (defaults.start) wrap.querySelector('.start').value = defaults.start;

      wrap.querySelector('.btn-del').addEventListener('click', ()=>{
        wrap.remove();
        persistAndCompute();
      });

      Array.from(wrap.querySelectorAll('.type, .amount, .rec, .cat, .start')).forEach(inp=>{
        inp.addEventListener('input', debounce(persistAndCompute, 200));
        inp.addEventListener('change', debounce(persistAndCompute, 200));
      });

      return wrap;
    }

    el('#addRow').onclick = () => { rows.appendChild(lineRow()); persistAndCompute(); };

    function collectEntries(){
      return [...rows.children].map(r => ({
        type: r.querySelector('.type').value,
        amount: r.querySelector('.amount').value,
        rec: r.querySelector('.rec').value,
        cat: r.querySelector('.cat').value,
        start: r.querySelector('.start').value
      }));
    }

    // ================ ScÃ©narios ================
    let scenario = { varMul: 1.0, extraIncome: 0, extraCredit: 0 };

    function applyScenario(entries){
      const out = entries.map(e=>({...e}));
      // variables * multiplicateur
      if (scenario.varMul !== 1){
        for (const e of out){
          if (e.type==='expense' && e.cat==='variable'){
            const amt = parseFloat(e.amount||"0");
            if (isFinite(amt)) e.amount = (amt*scenario.varMul).toFixed(2);
          }
        }
      }
      // extra revenus mensuels
      if (scenario.extraIncome>0){
        out.push({type:'income', amount: scenario.extraIncome, rec:'monthly', cat:'fixed', start: new Date().toISOString().slice(0,10)});
      }
      // extra crÃ©dit mensuel
      if (scenario.extraCredit>0){
        out.push({type:'expense', amount: scenario.extraCredit, rec:'monthly', cat:'credit', start: new Date().toISOString().slice(0,10)});
      }
      return out;
    }

    function setActiveChip(){
      els('.chip').forEach(b=>b.classList.remove('active'));
      if (scenario.varMul === 0.9) el('[data-scn="var-10"]')?.classList.add('active');
      if (scenario.extraIncome === 200) el('[data-scn="rev+200"]')?.classList.add('active');
      if (scenario.extraCredit === 300) el('[data-scn="cred+300"]')?.classList.add('active');
    }

    // ================ Projection par Ã©vÃ©nements (jour/jour) ================
    function generateEvents(entries, horizonDays, start){
      const evts = [];
      const end = addDays(start, horizonDays);
      for (const e of entries){
        const amt = parseFloat(e.amount || "0");
        if (!isFinite(amt) || amt === 0) continue;
        const sign = e.type === 'income' ? +1 : -1;
        let d = e.start ? new Date(e.start) : new Date(start);
        d.setHours(0,0,0,0);
        if (d < start) d = new Date(start);
        const rec = e.rec || 'monthly';
        const push = (dt) => { if (dt <= end) evts.push({date:new Date(dt), delta: sign*amt}); };
        if (rec === 'oneoff'){ push(d); }
        else {
          while (d <= end){
            push(d);
            if (rec === 'weekly') d.setDate(d.getDate()+7);
            else if (rec === 'monthly') d.setMonth(d.getMonth()+1);
            else if (rec === 'quarterly') d.setMonth(d.getMonth()+3);
            else if (rec === 'yearly') d.setFullYear(d.getFullYear()+1);
          }
        }
      }
      evts.sort((a,b)=>a.date-b.date);
      return evts;
    }

    function projectDaily(base, entries, horizonDays){
      const start = today0();
      const evts = generateEvents(entries, horizonDays, start);
      const out = [];
      let bal = base, i = 0;
      for (let d=0; d<=horizonDays; d++){
        const cur = addDays(start, d);
        while (i<evts.length && evts[i].date.getTime()===cur.getTime()){
          bal += evts[i].delta; i++;
        }
        out.push({date: cur, balance: Number(bal.toFixed(2))});
      }
      return out;
    }

    // ================ AgrÃ©gation mensuelle & Totaux ================
    function monthlyTotals(entries){
      const start = today0();
      const labels = [];
      const income = [];
      const expense = [];
      let d = new Date(start.getFullYear(), start.getMonth(), 1);
      for (let m=0; m<12; m++){
        const monthStart = new Date(d.getFullYear(), d.getMonth(), 1);
        const monthEnd = new Date(d.getFullYear(), d.getMonth()+1, 0);
        let inc = 0, exp = 0;
        for (const e of entries){
          const amt = parseFloat(e.amount||"0");
          if (!isFinite(amt) || amt===0) continue;
          const rec = e.rec||'monthly';
          const typ = e.type;
          const st = e.start ? new Date(e.start) : start;
          st.setHours(0,0,0,0);

          let add = 0;
          if (rec==='weekly') add = amt*4.333;        // ~52/12
          else if (rec==='monthly') add = amt;
          else if (rec==='quarterly'){
            const diff = (monthStart.getMonth()-st.getMonth()+12*(monthStart.getFullYear()-st.getFullYear()))%3;
            if (diff===0 && monthStart>=new Date(st.getFullYear(), st.getMonth(),1)) add = amt;
          } else if (rec==='yearly'){
            if (monthStart.getMonth()===st.getMonth() && monthStart.getFullYear()>=st.getFullYear()) add = amt;
          } else if (rec==='oneoff'){
            if (st>=monthStart && st<=monthEnd) add = amt;
          }

          if (typ==='income') inc += add; else exp += add;
        }
        labels.push(`${monthStart.toLocaleString(undefined,{month:'short'})}`);
        income.push(Number(inc.toFixed(2)));
        expense.push(Number(exp.toFixed(2)));
        d.setMonth(d.getMonth()+1);
      }
      return {labels, income, expense};
    }

    function monthlyKpis(entries){
      let inc=0, fix=0, vari=0, cred=0;
      for (const e of entries){
        const amt = parseFloat(e.amount||"0");
        if (!isFinite(amt) || amt===0) continue;
        const factor =
          (e.rec==='weekly') ? 4.333 :
          (e.rec==='monthly' || !e.rec) ? 1 :
          (e.rec==='quarterly') ? 1/3 :
          (e.rec==='yearly') ? 1/12 :
          0; // oneoff exclu des KPI mensuels
        const mAmt = amt*factor;
        if (e.type==='income') inc += mAmt;
        else {
          if (e.cat==='fixed') fix += mAmt;
          else if (e.cat==='credit') cred += mAmt;
          else vari += mAmt;
        }
      }
      const totalExp = fix + vari + cred;
      const debtRatio = inc>0 ? ( cred / inc ) : 0;    // <â€” cohÃ©rent avec â€œIdÃ©al < 35%â€
      const resteAVivre = inc - totalExp;
      const saveRate = inc>0 ? Math.max(inc - totalExp, 0)/inc : 0;
      return {
        debtPct: Math.max(0, debtRatio*100),
        reste: resteAVivre,
        savePct: Math.max(0, saveRate*100),
        inc, fix, vari, cred, totalExp
      };
    }

    // ================ Charts ================
    let lineChart, barsChart;
    function renderLine(curve){
      const labels = curve.map(p=>p.date.toISOString().slice(0,10));
      const values = curve.map(p=>p.balance);
      if (lineChart) lineChart.destroy();
      lineChart = new Chart(el('#chartLine'), {
        type:'line',
        data:{ labels, datasets:[{ label:'Solde projetÃ©', data:values, tension:0.3 }] },
        options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:false } } }
      });
    }
    function renderBars(labels, income, expense){
      if (barsChart) barsChart.destroy();
      barsChart = new Chart(el('#chartBars'), {
        type:'bar',
        data:{
          labels,
          datasets:[
            { label:'Revenus', data:income, stack:'stack1' },
            { label:'DÃ©penses', data:expense.map(v=>-v), stack:'stack1' }
          ]
        },
        options:{
          responsive:true,
          plugins:{ legend:{ position:'top' } },
          scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=>v } } }
        }
      });
    }

    // ================ Compute All ================
    function computeAll(){
      const base = parseFloat(el('#base').value||'0') || 0;
      const cur = el('#currency').value || '$';
      const modeDays = el('#mode365').checked ? 365 : 90;
      el('#horizon').value = modeDays;

      const rawEntries = collectEntries();
      const entries = applyScenario(rawEntries);

      // courbe journaliÃ¨re
      const curve = projectDaily(base, entries, modeDays);

      // KPIs
      const k = monthlyKpis(entries);
      el('#kpiDebt').textContent = isFinite(k.debtPct) ? `${k.debtPct.toFixed(1)}%` : 'â€”';
      el('#kpiRav').textContent = fmtMoney(k.reste, cur);
      el('#kpiSave').textContent = isFinite(k.savePct) ? `${k.savePct.toFixed(1)}%` : 'â€”';

      // Alerte dÃ©couvert
      const firstNeg = curve.findIndex(p => p.balance < 0);
      el('#alert').textContent = firstNeg === -1
        ? "âœ… Aucun risque de dÃ©couvert dÃ©tectÃ© sur lâ€™horizon choisi."
        : `âš ï¸ Risque de dÃ©couvert dans ${firstNeg} jours.`;

      // Cartes M+1 / M+6 / M+12 (si horizon court, on prend max dispo)
      const idx = d => Math.min(d, curve.length-1);
      el('#m1').textContent = fmtMoney(curve[idx(30)].balance, cur);
      el('#m6').textContent = fmtMoney(curve[idx(180)].balance, cur);
      el('#m12').textContent = fmtMoney(curve[idx(365)].balance, cur);

      // Graphiques
      renderLine(curve);
      const mt = monthlyTotals(entries);
      renderBars(mt.labels, mt.income, mt.expense);

      // Mailto rÃ©cap
      const d30 = curve[Math.min(30, curve.length-1)].balance;
      const d60 = curve[Math.min(60, curve.length-1)].balance;
      const d90 = curve[Math.min(90, curve.length-1)].balance;
      const subject = encodeURIComponent("Projection cashflow â€” Serenity Web");
      const body = encodeURIComponent(
`Bonjour,
Je viens de tester Serenity Web.

Solde initial: ${fmtMoney(base, cur)}
Indicateurs mensuels:
â€¢ Taux dâ€™endettement (crÃ©dit/revenus): ${isFinite(k.debtPct)?k.debtPct.toFixed(1):'â€”'}%
â€¢ Reste Ã  vivre: ${fmtMoney(k.reste, cur)}
â€¢ Taux dâ€™Ã©pargne: ${isFinite(k.savePct)?k.savePct.toFixed(1):'â€”'}%

Projection (${modeDays} jours):
â€¢ 30 jours: ${fmtMoney(d30, cur)}
â€¢ 60 jours: ${fmtMoney(d60, cur)}
â€¢ 90 jours: ${fmtMoney(d90, cur)}
${firstNeg === -1 ? "Aucun dÃ©couvert prÃ©vu." : "Risque de dÃ©couvert dans " + firstNeg + " jours."}

Je souhaite Ãªtre informÃ© quand la version Pro (sauvegarde, alertes, PDF) sera disponible.
Merci !`
      );
      el('#mailtoCta').href = `mailto:sinlocka@gmail.com?subject=${subject}&body=${body}`;
    }

    // ================ Persistence + Wiring ================
    function persistAndCompute(){
      const state = {
        base: el('#base').value,
        currency: el('#currency').value,
        mode365: el('#mode365').checked,
        rows: collectEntries(),
        scenario
      };
      saveState(state);
      setActiveChip();
      computeAll();
    }

    // events
    el('#compute').onclick = persistAndCompute;
    el('#resetScn').onclick = () => {
      scenario={varMul:1, extraIncome:0, extraCredit:0};
      setActiveChip();
      persistAndCompute();
    };
    els('input[name="hmode"]').forEach(r => r.addEventListener('change', persistAndCompute));
    el('#horizon').addEventListener('input', debounce(()=>{ 
      const v = parseInt(el('#horizon').value||'90',10);
      if (v>=200) { el('#mode365').checked = true; } else { el('#mode90').checked = true; }
      persistAndCompute();
    }, 300));
    el('#base').addEventListener('input', debounce(persistAndCompute, 200));
    el('#currency').addEventListener('change', persistAndCompute);

    els('.chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const t = btn.dataset.scn;
        // toggle exclusif par type de scÃ©nario
        if (t==='var-10') scenario.varMul = (scenario.varMul===0.9 ? 1.0 : 0.9);
        if (t==='rev+200') scenario.extraIncome = (scenario.extraIncome===200 ? 0 : 200);
        if (t==='cred+300') scenario.extraCredit = (scenario.extraCredit===300 ? 0 : 300);
        persistAndCompute();
      });
    });

    // initial state
    (function init(){
      const st = loadState();
      if (st){
        el('#base').value = st.base ?? 0;
        el('#currency').value = st.currency || '$';
        el('#mode365').checked = !!st.mode365;
        el('#mode90').checked = !st.mode365;
        scenario = st.scenario || {varMul:1, extraIncome:0, extraCredit:0};
        (st.rows || []).forEach(r => rows.appendChild(lineRow(r)));
      } else {
        rows.appendChild(lineRow({type:"income", amount:2500, rec:"monthly", cat:"fixed"}));
        rows.appendChild(lineRow({type:"expense", amount:1200, rec:"monthly", cat:"fixed"}));
        rows.appendChild(lineRow({type:"expense", amount:300, rec:"monthly", cat:"variable"}));
      }
      setActiveChip();
      computeAll();
    })();

    // Smooth scroll
    document.querySelectorAll('a[href^="#"]').forEach(a=>{
      a.addEventListener('click', e=>{
        const id = a.getAttribute('href');
        if (id.length>1){ e.preventDefault(); document.querySelector(id).scrollIntoView({behavior:'smooth'}); }
      });
    });

    // ===================== EXPORT PDF (beta) =====================

    // Calcule le score comme cÃ´tÃ© API (formule normalisÃ©e)
    function computeScoreFromKpis(k) {
      const revenus = k.inc || 0;
      const taux_epargne = revenus > 0 ? Math.max(revenus - k.totalExp, 0) / revenus : 0;
      const taux_charges = revenus > 0 ? (k.fix / revenus) : 0;
      const taux_dette   = revenus > 0 ? (k.cred / revenus) : 0;

      const comp_epargne = Math.min(taux_epargne / 0.20, 1.0);
      const comp_charges = 1 - Math.min(taux_charges / 0.50, 1.0);
      const comp_dette   = 1 - Math.min(taux_dette   / 0.20, 1.0);

      let score = Math.round(100 * (0.4*comp_epargne + 0.3*comp_charges + 0.3*comp_dette));
      score = Math.max(0, Math.min(100, score));
      let level = "rouge";
      if (score >= 85) level = "vert";
      else if (score >= 70) level = "jaune";
      else if (score >= 40) level = "orange";

      let message = "Situation fragile â€” il faut reprendre le contrÃ´le.";
      if (level === "orange") message = "Budget sous tension â€” des ajustements simples peuvent aider.";
      if (level === "jaune")  message = "Base saine â€” renforce ton Ã©pargne pour passer au vert.";
      if (level === "vert")   message = "Budget serein â€” ton argent travaille pour toi.";

      return { score, level, message, ratios: { taux_epargne, taux_charges, taux_dette } };
    }

    // RÃ©partition par catÃ©gorie (simple) depuis les KPI mensuels
    function breakdownByCategoryFromKpis(k){
      return [
        { label: "Fixe",     amount: Number((k.fix||0).toFixed(2)) },
        { label: "Variable", amount: Number((k.vari||0).toFixed(2)) },
        { label: "CrÃ©dit",   amount: Number((k.cred||0).toFixed(2)) }
      ];
    }

    // RÃ©partition par rÃ©currence (approx mensuelle) Ã  partir des entrÃ©es
    function breakdownByRecurring(entries){
      const sum = { "Mensuel":0, "Hebdo":0, "Ponctuel":0, "Trimestriel":0, "Annuel":0 };
      for (const e of entries){
        const amt = parseFloat(e.amount||"0");
        if (!isFinite(amt) || amt===0) continue;
        const rec = e.rec || "monthly";
        let mAmt = 0;
        if (rec==='weekly') mAmt = amt*4.333;
        else if (rec==='monthly') mAmt = amt;
        else if (rec==='quarterly') mAmt = amt/3;
        else if (rec==='yearly') mAmt = amt/12;
        else if (rec==='oneoff') mAmt = amt;
        if (rec==='weekly') sum["Hebdo"] += mAmt;
        else if (rec==='monthly') sum["Mensuel"] += mAmt;
        else if (rec==='quarterly') sum["Trimestriel"] += mAmt;
        else if (rec==='yearly') sum["Annuel"] += mAmt;
        else if (rec==='oneoff') sum["Ponctuel"] += mAmt;
      }
      return [
        { label:"Mensuel", amount:Number(sum["Mensuel"].toFixed(2)) },
        { label:"Hebdo", amount:Number(sum["Hebdo"].toFixed(2)) },
        { label:"Ponctuel", amount:Number(sum["Ponctuel"].toFixed(2)) },
        { label:"Trimestriel", amount:Number(sum["Trimestriel"].toFixed(2)) },
        { label:"Annuel", amount:Number(sum["Annuel"].toFixed(2)) }
      ];
    }

    // Construit le payload PDF Ã  partir de l'Ã©tat courant de la page
    function buildExportPayload({ base, cur, modeDays, entries, curve, k }){
      const idx = d => Math.min(d, curve.length-1);
      const milestones = {
        m1:  Number((curve[idx(30)].balance||0).toFixed(2)),
        m6:  Number((curve[idx(180)].balance||0).toFixed(2)),
        m12: Number((curve[idx(365)].balance||0).toFixed(2))
      };

      const scorePack = computeScoreFromKpis(k);

      const curveOut = curve.map(p => ({
        date: p.date.toISOString().slice(0,10),
        balance: Number((p.balance||0).toFixed(2))
      }));

      const byCat = breakdownByCategoryFromKpis(k);
      const byRec = breakdownByRecurring(entries);

      return {
        meta: {
          currency: cur,
          generated_at: new Date().toISOString(),
          horizon_days: modeDays
        },
        summary: {
          score: scorePack.score,
          level: scorePack.level,
          message: scorePack.message,
          solde: Number((k.inc - k.totalExp).toFixed(2)),
          ratios: scorePack.ratios,
          kpi: {
            debt_pct: Number(((k.inc>0? (k.cred/k.inc)*100 : 0)).toFixed(1)),
            reste_a_vivre: Number((k.reste||0).toFixed(2)),
            save_pct: Number((k.savePct||0).toFixed(1)),
            inc: Number((k.inc||0).toFixed(2)),
            fix: Number((k.fix||0).toFixed(2)),
            vari: Number((k.vari||0).toFixed(2)),
            cred: Number((k.cred||0).toFixed(2)),
            total_exp: Number((k.totalExp||0).toFixed(2))
          }
        },
        milestones,
        curve: curveOut,
        breakdown: {
          by_category: byCat,
          by_recurring: byRec
        },
        tips: buildTipsForPdf(scorePack, k, cur),
        disclaimer: "Ce document est fourni Ã  titre indicatif."
      };
    }

    // Conseils simples
    function buildTipsForPdf(scorePack, k, cur){
      const tips = [];
      const revenus = k.inc || 0;
      const need20 = Math.max(0, 0.20*revenus - Math.max(revenus - k.totalExp, 0));
      if (need20 > 0) tips.push(`Augmente lâ€™Ã©pargne mensuelle de ${cur}${need20.toFixed(2)} pour viser 20 %.`);
      const overFix = k.fix - 0.50*revenus;
      if (overFix > 0) tips.push(`RÃ©duis les charges fixes dâ€™environ ${cur}${overFix.toFixed(2)} pour repasser sous 50 %.`);
      const overDebt = k.cred - 0.20*revenus;
      if (overDebt > 0) tips.push(`NÃ©gocie/solde ${cur}${overDebt.toFixed(2)} de mensualitÃ©s pour revenir sous 20 %.`);
      if (!tips.length) tips.push("Continue : maintiens ton cap et renforce progressivement lâ€™Ã©pargne.");
      return tips;
    }

    // Appel API + tÃ©lÃ©chargement
    async function exportPdf(){
      try {
        const base = parseFloat(el('#base').value||'0') || 0;
        const cur = el('#currency').value || '$';
        const modeDays = el('#mode365').checked ? 365 : 90;

        const rawEntries = collectEntries();
        const entries = applyScenario(rawEntries);
        const curve = projectDaily(base, entries, modeDays);
        const k = monthlyKpis(entries);

        const payload = buildExportPayload({ base, cur, modeDays, entries, curve, k });

        const res = await fetch('/api/export-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Erreur serveur (${res.status}): ${text}`);
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'serenity-web-projection.pdf';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert("Ã‰chec de l'export PDF : " + e.message);
      }
    }

    // Active le bouton aprÃ¨s 1er calcul et branche le clic
    (function wireExportBtn(){
      const btn = el('#exportPdf');
      if (!btn) return;
      btn.addEventListener('click', exportPdf);
      const _oldComputeAll = computeAll;
      computeAll = function(){
        _oldComputeAll();
        btn.disabled = false;
      };
    })();

  </script>
</body>
</html>
