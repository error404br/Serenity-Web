<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Serenity Web â€” Simulateur de Cashflow (MVP)</title>
  <meta name="description" content="Projetez votre cash Ã  90 jours ou 12 mois. Indicateurs: taux dâ€™endettement, reste Ã  vivre, taux dâ€™Ã©pargne.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--brand:#0b2545}
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:1.25rem;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .kpi-label{font-size:.75rem;color:#64748b}
    .kpi-value{font-size:1.35rem;font-weight:800}
    .chip{border:1px solid #e5e7eb;border-radius:9999px;padding:.4rem .8rem;font-size:.85rem;cursor:pointer}
    .chip.active{background:#0b2545;color:#fff;border-color:#0b2545}
    .btn-del{border:1px solid #e5e7eb;border-radius:.65rem;padding:.35rem .6rem;font-size:.8rem}
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-5 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-xl bg-[color:var(--brand)]"></div>
        <span class="font-semibold">Serenity <span class="text-slate-500">Web</span></span>
      </div>
      <nav class="text-sm hidden sm:flex gap-6">
        <a href="#simulateur" class="hover:underline">Simulateur</a>
        <a href="#projection" class="hover:underline">Projection</a>
        <a href="#faq" class="hover:underline">FAQ</a>
      </nav>
      <a href="#simulateur" class="px-3 py-2 rounded-xl bg-[color:var(--brand)] text-white text-sm">Essayer maintenant</a>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-6xl mx-auto px-5 py-12 md:py-16">
    <div class="grid md:grid-cols-2 gap-10 items-center">
      <div>
        <h1 class="text-3xl md:text-5xl font-extrabold leading-tight">
          Votre finance, claire et sereine.
        </h1>
        <p class="mt-4 text-slate-600">
          Projetez <strong>90 jours</strong> ou <strong>12 mois</strong> en 1 minute.
          Taux dâ€™endettement, reste Ã  vivre, taux dâ€™Ã©pargne â€” <em>calcul 100% local, sans inscription</em>.
        </p>

        <div class="mt-6 flex flex-wrap gap-3">
          <a href="#simulateur" class="px-4 py-3 rounded-2xl bg-[color:var(--brand)] text-white font-semibold">Lancer le simulateur</a>
          <a href="#projection" class="px-4 py-3 rounded-2xl bg-white border border-slate-200">Voir un exemple</a>
        </div>
      </div>

      <div class="card p-6">
        <div class="aspect-video rounded-2xl bg-gradient-to-br from-slate-100 to-white grid place-items-center text-slate-500">
          Graphiques solde & revenus/dÃ©penses
        </div>
        <p class="mt-4 text-sm text-slate-600">
          La version Pro permet dâ€™enregistrer plusieurs scÃ©narios, dâ€™obtenir des alertes e-mail et dâ€™exporter vos projections en PDF.
        </p>
      </div>
    </div>
  </section>

  <!-- Simulateur -->
  <section id="simulateur" class="max-w-6xl mx-auto px-5 py-8 grid lg:grid-cols-2 gap-8">

    <!-- COLONNE PARAMÃˆTRES -->
    <div class="card p-6">

      <!-- NOUVEAU: Nom du scÃ©nario -->
      <h2 class="text-xl font-bold mb-2">Nom du scÃ©nario</h2>
      <input id="scenarioName" type="text"
             class="w-full border rounded-xl p-2 mb-6"
             placeholder="Nom du scÃ©nario"
             value="Budget actuel">

      <!-- ParamÃ¨tres -->
      <h2 class="text-xl font-bold">Vos paramÃ¨tres</h2>
      <p class="text-sm text-slate-600">Renseignez un solde initial et vos flux rÃ©currents.</p>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-slate-600 mb-1">Solde initial</label>
          <input id="base" type="number" class="w-full border rounded-xl p-2" value="0" step="0.01">
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Devise</label>
          <select id="currency" class="w-full border rounded-xl p-2">
            <option value="$" selected>$</option>
            <option value="â‚¬">â‚¬</option>
            <option value="C$">C$</option>
          </select>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3 items-center">
        <div>
          <label class="block text-sm text-slate-600 mb-1">Horizon</label>
          <div class="flex items-center gap-2">
            <input type="radio" name="hmode" id="mode90" value="90" checked>
            <label for="mode90" class="text-sm">90 jours</label>

            <input type="radio" name="hmode" id="mode365" value="365" class="ml-4">
            <label for="mode365" class="text-sm">12 mois</label>
          </div>
        </div>

        <div>
          <label class="block text-sm text-slate-600 mb-1">Horizon (jours)</label>
          <input id="horizon" type="number" class="w-full border rounded-xl p-2" value="90" min="30" max="365">
          <p class="text-[11px] text-slate-500 mt-1">Basculer 90j/12m ajuste automatiquement.</p>
        </div>
      </div>
      <!-- Lignes de revenus/dÃ©penses -->

      <div class="mt-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Lignes de revenus/dÃ©penses</h3>
          <button id="addRow" class="text-sm px-3 py-1 rounded-lg bg-slate-900 text-white">+ Ajouter</button>
        </div>

        <div class="grid grid-cols-12 gap-2 text-[12px] text-slate-500">
          <div class="col-span-2">Type</div>
          <div class="col-span-2">Montant</div>
          <div class="col-span-3">RÃ©currence</div>
          <div class="col-span-3">CatÃ©gorie</div>
          <div class="col-span-2">DÃ©but</div>
        </div>

        <div id="rows" class="space-y-3 mt-1"></div>

        <p class="mt-2 text-xs text-slate-500">
          CatÃ©gories : <strong>Fixe</strong> (loyer, assurances),
          <strong>Variable</strong> (courses, loisirs),
          <strong>CrÃ©dit</strong> (mensualitÃ©).
        </p>
      </div>

      <div class="mt-6 flex flex-wrap gap-2">
        <button id="compute" class="px-4 py-3 rounded-2xl bg-emerald-600 text-white font-semibold">
          Calculer ma projection
        </button>
        <button id="resetScn" class="px-4 py-3 rounded-2xl bg-white border">
          RÃ©initialiser
        </button>
      </div>

      <!-- ScÃ©narios rapides -->
      <div class="mt-4 flex flex-wrap gap-2">
        <span class="text-sm text-slate-600 mr-2">ScÃ©narios rapides :</span>
        <button class="chip" data-scn="var-10">âˆ’10% variables</button>
        <button class="chip" data-scn="rev+200">+200 / mois revenus</button>
        <button class="chip" data-scn="cred+300">+300 / mois crÃ©dit</button>
      </div>

    </div> <!-- fin col gauche -->


    <!-- COLONNE INDICATEURS -->
    <div class="card p-6">
      <h2 class="text-xl font-bold">Indicateurs</h2>

      <div class="grid sm:grid-cols-3 gap-3 mt-3">
        <div class="p-4 rounded-2xl bg-slate-50">
          <div class="kpi-label">Taux dâ€™endettement</div>
          <div id="kpiDebt" class="kpi-value">â€”</div>
        </div>

        <div class="p-4 rounded-2xl bg-slate-50">
          <div class="kpi-label">Reste Ã  vivre (mensuel)</div>
          <div id="kpiRav" class="kpi-value">â€”</div>
        </div>

        <div class="p-4 rounded-2xl bg-slate-50">
          <div class="kpi-label">Taux dâ€™Ã©pargne</div>
          <div id="kpiSave" class="kpi-value">â€”</div>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-3 text-center mt-6">
        <div class="p-4 rounded-2xl bg-emerald-50">
          <div class="text-xs text-slate-600">M+1</div>
          <div id="m1" class="text-2xl font-extrabold">â€”</div>
        </div>

        <div class="p-4 rounded-2xl bg-amber-50">
          <div class="text-xs text-slate-600">M+6</div>
          <div id="m6" class="text-2xl font-extrabold">â€”</div>
        </div>

        <div class="p-4 rounded-2xl bg-rose-50">
          <div class="text-xs text-slate-600">M+12</div>
          <div id="m12" class="text-2xl font-extrabold">â€”</div>
        </div>
      </div>

      <p id="alert" class="mt-4 text-sm"></p>

      <!-- CTA Email / Excel -->
      <div class="mt-6 grid gap-3 sm:grid-cols-2">
        <a id="mailtoCta" href="#"
           class="text-center px-4 py-3 rounded-2xl bg-[color:var(--brand)] text-white font-semibold">
          Recevoir ma projection par e-mail
        </a>

        <a href="https://www.etsy.com/ca-fr/listing/1766882287/previsionnel-comptable-bilan"
           class="text-center px-4 py-3 rounded-2xl bg-white border border-slate-200">
          ðŸ“¥ TÃ©lÃ©charger Serenity Files (Excel)
        </a>
      </div>

      <!-- Export PDF -->
      <div class="mt-6">
        <button id="exportPdf"
                class="px-4 py-3 rounded-2xl bg-slate-900 text-white font-semibold w-full sm:w-auto"
                disabled>
          ðŸ”’ Exporter en PDF (beta)
        </button>
        <p class="text-xs text-slate-500 mt-1">
          Fonction expÃ©rimentale â€” nÃ©cessite la version Pro dans le futur.
        </p>
      </div>

    </div> <!-- fin col droite -->
  </section>


  <!-- PROJECTION GRAPHIQUES -->
  <section id="projection"
           class="max-w-6xl mx-auto px-5 py-8 grid lg:grid-cols-2 gap-8">

    <div class="card p-6">
      <h3 class="text-lg font-semibold">Solde projetÃ©</h3>
      <canvas id="chartLine" class="mt-4"></canvas>
    </div>

    <div class="card p-6">
      <h3 class="text-lg font-semibold">Revenus vs DÃ©penses (par mois)</h3>
      <canvas id="chartBars" class="mt-4"></canvas>
    </div>

  </section>


  <!-- FAQ -->
  <section id="faq" class="max-w-6xl mx-auto px-5 py-8">
    <h3 class="text-xl font-bold">FAQ rapide</h3>

    <div class="mt-4 grid md:grid-cols-2 gap-4">
      <div class="card p-4">
        <p class="font-semibold">Mes donnÃ©es sont-elles stockÃ©es ?</p>
        <p class="text-sm text-slate-600 mt-1">
          Non, le calcul est local. La version Pro ajoutera une sauvegarde cloud.
        </p>
      </div>

      <div class="card p-4">
        <p class="font-semibold">Puis-je enregistrer un scÃ©nario ?</p>
        <p class="text-sm text-slate-600 mt-1">
          Le MVP recharge automatiquement vos entrÃ©es.
        </p>
      </div>
    </div>
  </section>


  <!-- FOOTER -->
  <footer class="mt-10 border-t">
    <div class="max-w-6xl mx-auto px-5 py-8 text-sm text-slate-600 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
      <div>Â© Serenity Web â€” un projet BuildToSolve</div>
      <a href="mailto:sinlocka@gmail.com" class="underline">sinlocka@gmail.com</a>
    </div>
  </footer>


  <!-- SCRIPT PRINCIPAL : LOGIQUE SERENITY WEB -->
  <script>

  /* ============================================================
     1 â€” SHORTCUTS + UTIL
  ============================================================ */
  const el = s => document.querySelector(s);
  const els = s => Array.from(document.querySelectorAll(s));

  const today0 = () => { const d=new Date(); d.setHours(0,0,0,0); return d; };
  const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
  const debounce = (fn,t=250)=>{ let id;return(...args)=>{clearTimeout(id);id=setTimeout(()=>fn(...args),t);} };

  const fmtMoney = (n,cur)=>{
    if(!isFinite(n))return'â€”';
    const s = n<0 ? '-' : '';
    return `${s}${cur}${Math.abs(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
  };


  /* ============================================================
     2 â€” API CONFIG + WAKE
  ============================================================ */

  const API_BASE = (() => {
    const host = window.location.hostname;
    if (host === "localhost" || host === "127.0.0.1") return "http://127.0.0.1:8000";
    return "https://serenity-web-api.onrender.com";
  })();

  async function wakeApi() {
    try {
      await fetch(API_BASE + "/", { method:"GET", mode:"no-cors", cache:"no-store" });
      console.log("Wake API envoyÃ©");
    } catch(e){
      console.warn("Wake API failed:", e);
    }
  }


  /* ============================================================
     3 â€” DYNAMIC ROWS (ENTRIES)
  ============================================================ */

  const rows = el("#rows");

  function lineRow(defaults={}) {
    const wrap = document.createElement("div");
    wrap.className = "grid grid-cols-12 gap-2 items-end";

    wrap.innerHTML = `
      <select class="col-span-2 border rounded-xl p-2 type">
        <option value="income">Revenu</option>
        <option value="expense">DÃ©pense</option>
      </select>

      <input class="col-span-2 border rounded-xl p-2 amount" type="number" step="0.01">

      <select class="col-span-3 border rounded-xl p-2 rec">
        <option value="oneoff">Ponctuel</option>
        <option value="weekly">Hebdo</option>
        <option value="monthly" selected>Mensuel</option>
        <option value="quarterly">Trimestriel</option>
        <option value="yearly">Annuel</option>
      </select>

      <select class="col-span-3 border rounded-xl p-2 cat">
        <option value="fixed">Fixe</option>
        <option value="variable">Variable</option>
        <option value="credit">CrÃ©dit</option>
      </select>

      <div class="col-span-2 flex gap-2">
        <input class="border rounded-xl p-2 start flex-1" type="date">
        <button class="btn-del" title="Supprimer">ðŸ—‘</button>
      </div>
    `;

    if(defaults.type) wrap.querySelector(".type").value = defaults.type;
    if(defaults.amount!=null) wrap.querySelector(".amount").value = defaults.amount;
    if(defaults.rec) wrap.querySelector(".rec").value = defaults.rec;
    if(defaults.cat) wrap.querySelector(".cat").value = defaults.cat;
    if(defaults.start) wrap.querySelector(".start").value = defaults.start;

    wrap.querySelector(".btn-del").addEventListener("click", ()=>{
      wrap.remove();
      persistAndCompute();
    });

    wrap.querySelectorAll(".type, .amount, .rec, .cat, .start")
      .forEach(inp=>{
        inp.addEventListener("input", debounce(persistAndCompute,200));
        inp.addEventListener("change", debounce(persistAndCompute,200));
      });

    return wrap;
  }

  el("#addRow").onclick = () => {
    rows.appendChild(lineRow());
    persistAndCompute();
  };

  function collectEntries() {
    return [...rows.children].map(r=>({
      type: r.querySelector(".type").value,
      amount: r.querySelector(".amount").value,
      rec: r.querySelector(".rec").value,
      cat: r.querySelector(".cat").value,
      start: r.querySelector(".start").value
    }));
  }


  /* ============================================================
     4 â€” SCÃ‰NARIOS RAPIDES (var, revenu+, crÃ©dit+)
  ============================================================ */

  let scenario = { varMul:1.0, extraIncome:0, extraCredit:0 };

  function applyScenario(entries){
    const out = entries.map(e=>({...e}));

    if(scenario.varMul!==1){
      for(const e of out){
        if(e.type==="expense" && e.cat==="variable"){
          const amt = parseFloat(e.amount||"0");
          if(isFinite(amt)) e.amount = (amt * scenario.varMul).toFixed(2);
        }
      }
    }

    if(scenario.extraIncome>0){
      out.push({
        type:"income",
        amount:scenario.extraIncome,
        rec:"monthly",
        cat:"fixed",
        start:new Date().toISOString().slice(0,10)
      });
    }

    if(scenario.extraCredit>0){
      out.push({
        type:"expense",
        amount:scenario.extraCredit,
        rec:"monthly",
        cat:"credit",
        start:new Date().toISOString().slice(0,10)
      });
    }

    return out;
  }

  function setActiveChip(){
    els(".chip").forEach(b=>b.classList.remove("active"));
    if(scenario.varMul===0.9) el('[data-scn="var-10"]')?.classList.add("active");
    if(scenario.extraIncome===200) el('[data-scn="rev+200"]')?.classList.add("active");
    if(scenario.extraCredit===300) el('[data-scn="cred+300"]')?.classList.add("active");
  }


  /* ============================================================
     5 â€” CALCUL (LOCAL + API)
  ============================================================ */

  function buildPayloadForApi(base, cur, modeDays, entries){
    return {
      scenario_name: el("#scenarioName").value,
      base,
      currency: cur,
      horizon_days: modeDays,
      entries
    };
  }

  async function computeViaApi(base, cur, modeDays, entries){
    try {
      const res = await fetch(API_BASE + "/api/calc", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(buildPayloadForApi(base,cur,modeDays,entries))
      });

      if(!res.ok) throw new Error("API calc failed");

      return await res.json();
    }
    catch(e){
      console.warn("API calc error â†’ fallback local :", e);
      return null;
    }
  }

  /* ------- CALCUL LOCAL ------- */

  function generateEvents(entries, horizonDays){
    const start = today0();
    const end = addDays(start, horizonDays);
    const evts = [];

    for(const e of entries){
      const amt = parseFloat(e.amount||"0");
      if(!isFinite(amt) || amt===0) continue;
      const sign = e.type==="income" ? +1 : -1;

      let d = e.start ? new Date(e.start) : new Date(start);
      d.setHours(0,0,0,0);
      if(d < start) d = new Date(start);

      const rec = e.rec||"monthly";

      const push = dt => { if(dt<=end) evts.push({date:new Date(dt), delta:sign*amt}); };

      if(rec==="oneoff"){ push(d); }
      else {
        while(d<=end){
          push(d);
          if(rec==="weekly") d.setDate(d.getDate()+7);
          else if(rec==="monthly") d.setMonth(d.getMonth()+1);
          else if(rec==="quarterly") d.setMonth(d.getMonth()+3);
          else if(rec==="yearly") d.setFullYear(d.getFullYear()+1);
        }
      }
    }

    evts.sort((a,b)=>a.date - b.date);
    return evts;
  }

  function projectDaily(base, entries, horizonDays){
    const start = today0();
    const evts = generateEvents(entries, horizonDays);
    const out = [];
    let bal = base, i = 0;

    for(let d=0; d<=horizonDays; d++){
      const cur = addDays(start, d);
      while(i<evts.length && evts[i].date.getTime()===cur.getTime()){
        bal += evts[i].delta;
        i++;
      }
      out.push({date:cur, balance:Number(bal.toFixed(2))});
    }

    return out;
  }

  function monthlyTotals(entries){
    const start = today0();
    const labels = [];
    const income = [];
    const expense = [];
    let d = new Date(start.getFullYear(), start.getMonth(), 1);

    for(let m=0; m<12; m++){
      const monthStart = new Date(d.getFullYear(), d.getMonth(), 1);
      const monthEnd = new Date(d.getFullYear(), d.getMonth()+1, 0);

      let inc=0, exp=0;

      for(const e of entries){
        const amt = parseFloat(e.amount||"0");
        if(!isFinite(amt) || amt===0) continue;

        const rec = e.rec||"monthly";
        const typ = e.type;
        const st = e.start ? new Date(e.start) : start;
        st.setHours(0,0,0,0);

        let add = 0;

        if(rec==="weekly") add = amt * 4.333;
        else if(rec==="monthly") add = amt;
        else if(rec==="quarterly"){
          const diff = (
            monthStart.getMonth() -
            st.getMonth() +
            12 * (monthStart.getFullYear() - st.getFullYear())
          ) % 3;
          if(diff===0 && monthStart >= new Date(st.getFullYear(), st.getMonth(),1)) add = amt;
        }
        else if(rec==="yearly"){
          if(monthStart.getMonth()===st.getMonth() && monthStart.getFullYear()>=st.getFullYear())
            add = amt;
        }
        else if(rec==="oneoff"){
          if(st>=monthStart && st<=monthEnd) add = amt;
        }

        if(typ==="income") inc += add;
        else exp += add;
      }

      labels.push(monthStart.toLocaleString(undefined,{month:"short"}));
      income.push(Number(inc.toFixed(2)));
      expense.push(Number(exp.toFixed(2)));

      d.setMonth(d.getMonth()+1);
    }

    return { labels, income, expense };
  }

  function monthlyKpis(entries){
    let inc=0, fix=0, vari=0, cred=0;

    for(const e of entries){
      const amt = parseFloat(e.amount||"0");
      if(!isFinite(amt) || amt===0) continue;

      let factor=0;
      if(e.rec==="weekly") factor = 4.333;
      else if(e.rec==="monthly" || !e.rec) factor = 1;
      else if(e.rec==="quarterly") factor = 1/3;
      else if(e.rec==="yearly") factor = 1/12;

      const mAmt = amt * factor;

      if(e.type==="income") inc += mAmt;
      else {
        if(e.cat==="fixed") fix += mAmt;
        else if(e.cat==="credit") cred += mAmt;
        else vari += mAmt;
      }
    }

    const totalExp = fix + vari + cred;
    const reste = inc - totalExp;

    return {
      inc,
      fix,
      vari,
      cred,
      totalExp,
      reste,
      debtPct: inc>0 ? (cred/inc)*100 : 0,
      savePct: inc>0 ? Math.max(reste,0)/inc*100 : 0
    };
  }


  /* ============================================================
     6 â€” RENDER CHARTS
  ============================================================ */

  let lineChart, barsChart;

  function renderLine(curve){
    const labels = curve.map(p => p.date.toISOString().slice(0,10));
    const values = curve.map(p => p.balance);

    if(lineChart) lineChart.destroy();

    lineChart = new Chart(el("#chartLine"), {
      type:"line",
      data:{
        labels,
        datasets:[
          { label:"Solde projetÃ©", data:values, tension:0.3 }
        ]
      },
      options:{
        plugins:{ legend:{display:false} },
        scales:{ y:{ beginAtZero:false } }
      }
    });
  }

  function renderBars(labels, income, expense){
    if(barsChart) barsChart.destroy();

    barsChart = new Chart(el("#chartBars"), {
      type:"bar",
      data:{
        labels,
        datasets:[
          { label:"Revenus", data:income, stack:"s1" },
          { label:"DÃ©penses", data:expense.map(v=>-v), stack:"s1" }
        ]
      },
      options:{
        plugins:{ legend:{position:"top"} },
        scales:{ y:{beginAtZero:true} }
      }
    });
  }


    /* ============================================================
     7 â€” EXPORT PDF
  ============================================================ */

  async function exportPdf(){
    try{
      const base = parseFloat(el("#base").value||"0")||0;
      const cur = el("#currency").value||"$";
      const modeDays = el("#mode365").checked ? 365 : 90;

      const rawEntries = collectEntries();
      const entries = applyScenario(rawEntries);
      const curve = projectDaily(base, entries, modeDays);
      const k = monthlyKpis(entries);

      const payload = {
        scenario_name: el("#scenarioName").value,
        base,
        currency: cur,
        horizon_days: modeDays,
        entries,
        curve: curve.map(p=>({
          date:p.date.toISOString().slice(0,10),
          balance:p.balance
        }))
      };

      const res = await fetch(API_BASE + "/api/export-pdf", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payload)
      });

      if(!res.ok) throw new Error("Erreur API PDF");

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url;
      a.download="serenity-web-projection.pdf";
      a.click();
      URL.revokeObjectURL(url);
    }
    catch(e){
      alert("Export PDF impossible : " + e.message);
    }
  }



  /* ============================================================
     8 â€” PERSISTENCE LOCALSTORAGE
  ============================================================ */

  const LS_KEY = "serenityweb_state_v2";

  function saveState(state){
    try { localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    catch(e){}
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch(e){ return null; }
  }


  /* ============================================================
     9 â€” COMPUTE (FUSION API + LOCAL)
  ============================================================ */

  async function computeAll(){

    const scenarioName = el("#scenarioName").value;
    const base = parseFloat(el("#base").value||"0")||0;
    const cur = el("#currency").value||"$";
    const modeDays = el("#mode365").checked ? 365 : 90;

    const rawEntries = collectEntries();
    const entries = applyScenario(rawEntries);

    let result = await computeViaApi(base, cur, modeDays, entries);

    if(!result){
      const curve = projectDaily(base, entries, modeDays);
      const k = monthlyKpis(entries);
      const mt = monthlyTotals(entries);

      result = {
        curve: curve.map(p=>({
          date:p.date.toISOString().slice(0,10),
          balance:p.balance
        })),
        kpi: {
          debt_pct: k.debtPct,
          reste_a_vivre: k.reste,
          save_pct: k.savePct,
          inc: k.inc,
          fix: k.fix,
          vari: k.vari,
          cred: k.cred,
          total_exp: k.totalExp
        },
        monthly_totals: mt,
      };
    }

    const curve = result.curve;
    const k = result.kpi;

    el("#kpiDebt").textContent = `${k.debt_pct.toFixed(1)}%`;
    el("#kpiRav").textContent = fmtMoney(k.reste_a_vivre, cur);
    el("#kpiSave").textContent = `${k.save_pct.toFixed(1)}%`;

    function idx(d){ return Math.min(d, curve.length-1); }

    el("#m1").textContent  = fmtMoney(curve[idx(30)].balance, cur);
    el("#m6").textContent  = fmtMoney(curve[idx(180)].balance, cur);
    el("#m12").textContent = fmtMoney(curve[idx(365)].balance, cur);

    const firstNeg = curve.findIndex(p=>p.balance<0);
    el("#alert").textContent =
      firstNeg===-1
        ? "âœ… Aucun risque de dÃ©couvert dÃ©tectÃ©."
        : `âš ï¸ Risque de dÃ©couvert dans ${firstNeg} jours.`;

    renderLine(curve.map(p=>({date:new Date(p.date), balance:p.balance})));
    renderBars(
      result.monthly_totals.labels,
      result.monthly_totals.income,
      result.monthly_totals.expense
    );

    const subject = encodeURIComponent("Projection cashflow â€” Serenity Web");
    const body = encodeURIComponent(
`Bonjour,
Je viens de tester Serenity Web.

ScÃ©nario : ${scenarioName}

Solde initial : ${fmtMoney(base,cur)}

Indicateurs :
â€¢ Taux dâ€™endettement : ${k.debt_pct.toFixed(1)}%
â€¢ Reste Ã  vivre : ${fmtMoney(k.reste_a_vivre,cur)}
â€¢ Taux dâ€™Ã©pargne : ${k.save_pct.toFixed(1)}%

Projection :
â€¢ 30 jours : ${fmtMoney(curve[idx(30)].balance,cur)}
â€¢ 60 jours : ${fmtMoney(curve[idx(60)].balance,cur)}
â€¢ 90 jours : ${fmtMoney(curve[idx(90)].balance,cur)}

${firstNeg===-1 ? "Aucun dÃ©couvert prÃ©vu." : "Risque de dÃ©couvert dans " + firstNeg + " jours."}

Merci !`
    );

    el("#mailtoCta").href = `mailto:sinlocka@gmail.com?subject=${subject}&body=${body}`;

    el("#exportPdf").disabled = false;

    saveState({
      scenarioName,
      base: el("#base").value,
      currency: el("#currency").value,
      mode365: el("#mode365").checked,
      rows: collectEntries(),
      scenario
    });
  }


  /* ============================================================
     10 â€” INIT + Ã‰VÃ‰NEMENTS
  ============================================================ */

  el("#compute").onclick = computeAll;
  el("#resetScn").onclick = ()=>{
    scenario = { varMul:1, extraIncome:0, extraCredit:0 };
    setActiveChip();
    computeAll();
  };

  els(".chip").forEach(btn=>{
    btn.onclick = ()=>{
      const t = btn.dataset.scn;
      if(t==="var-10") scenario.varMul = (scenario.varMul===0.9 ? 1 : 0.9);
      if(t==="rev+200") scenario.extraIncome = (scenario.extraIncome===200 ? 0 : 200);
      if(t==="cred+300") scenario.extraCredit = (scenario.extraCredit===300 ? 0 : 300);
      persistAndCompute();
    };
  });

  function persistAndCompute(){ computeAll(); }

  /* INIT */
  (async function init(){
    wakeApi();

    const st = loadState();
    if(st){
      el("#scenarioName").value = st.scenarioName || "Budget actuel";
      el("#base").value = st.base ?? 0;
      el("#currency").value = st.currency || "$";

      el("#mode365").checked = !!st.mode365;
      el("#mode90").checked = !st.mode365;

      scenario = st.scenario || scenario;

      (st.rows || []).forEach(r => rows.appendChild(lineRow(r)));
    }
    else {
      rows.appendChild(lineRow({ type:"income", amount:2500, rec:"monthly", cat:"fixed" }));
      rows.appendChild(lineRow({ type:"expense", amount:1200, rec:"monthly", cat:"fixed" }));
      rows.appendChild(lineRow({ type:"expense", amount:300, rec:"monthly", cat:"variable" }));
    }

    setActiveChip();
    computeAll();
  })();

  </script>

</body>
</html>
